<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
  </head>
  <body>
    <pre id='e_info'></pre>
    <div id='e_parent'>
      <canvas id='e_canvas'></canvas>
    </div>
    <script>

function ASSERT(cond, text) {
  if (!cond) {
    text = 'Assertion hit: ' + text;
    throw new Error(text);
  }
}

// -

function snap_to_parent_pixels(e) {
  const p = e.parentNode;
  const p_rect = p.getBoundingClientRect();

  const DPR = window.devicePixelRatio;

  const device_rect = {
    top   : Math.round(p_rect.top    * DPR),
    bottom: Math.round(p_rect.bottom * DPR),
    left  : Math.round(p_rect.left   * DPR),
    right : Math.round(p_rect.right  * DPR),
  };
  device_rect.width = device_rect.right - device_rect.left;
  device_rect.height = device_rect.bottom - device_rect.top;

  e.style.position = 'absolute';
  e.style.width = (device_rect.width) / DPR + 'px';
  e.style.height = (device_rect.height) / DPR + 'px';

  e_info.textContent = [
    'window.devicePixelRatio: ' + DPR,
    'screen.width: ' + screen.width,
    'screen.height: ' + screen.height,
    'parent_rect.w: ' + p_rect.width,
    'parent_rect.h: ' + p_rect.height,
    'device_rect.w: ' + device_rect.width,
    'device_rect.h: ' + device_rect.height,
    'e.style.width: ' + e.style.width,
    'e.style.height: ' + e.style.height,
  ].join('\n')

  return device_rect;
}

const attribs = {
  alpha: false,
  premultipliedAlpha: true,
  antialias: false,
  depth: false,
  stencil: false,
  preserveDrawingBuffer: false,
};
const gl = e_canvas.getContext('webgl', attribs);
ASSERT(gl);
ASSERT(gl.drawingBufferWidth == gl.canvas.width);
ASSERT(gl.drawingBufferHeight == gl.canvas.height);

let frame_id = 0;
function frame() {
  requestAnimationFrame(frame);
  frame_id += 1;

  const t = performance.now() / 1000;
  const k = (2.0 + Math.cos(t/2)) / 3.0;


  if (frame_id % 1 == 0) {
    e_parent.style.marginTop = 60 + 30 * Math.sin(t/1) + 'px';
    e_parent.style.marginLeft = 40 + 30 * Math.cos(t/1) + 'px';
  }
  e_parent.style.width = 400 * k + 'px';
  e_parent.style.height = 300 * k + 'px';

  const dev_rect = snap_to_parent_pixels(e_canvas);
  e_canvas.width = dev_rect.width;
  e_canvas.height = dev_rect.height;

  gl.clearColor(1, 1, 1, 1);
  gl.clear(gl.COLOR_BUFFER_BIT);

  gl.enable(gl.SCISSOR_TEST);

  gl.clearColor(1, 0, 0, 1);
  for (let x = dev_rect.left; x < dev_rect.right; x++) {
    if (x % 2 == 0) continue;
    gl.scissor(x - dev_rect.left, 0, 1, e_canvas.height);
    gl.clear(gl.COLOR_BUFFER_BIT);
  }

  gl.clearColor(0, 0, 1, 1);
  for (let y = dev_rect.top; y < dev_rect.bottom; y++) {
    if (y % 2 == 0) continue;
    gl.scissor(0, e_canvas.height - (y - dev_rect.top) - 1, e_canvas.width, 1);
    gl.clear(gl.COLOR_BUFFER_BIT);
  }
}
frame();
    </script>
  </body>
</html>
