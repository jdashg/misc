<!DOCTYPE html>
<html>
  <head>
    <meta charset='UTF-8'>
    <script src='matrices.js'></script>
  </head>
  <body>

Color space: <select id='e_color_space'>
    <option value='rec601'>Rec601</option>
    <option value='rec709' selected>Rec709</option>
    <option value='rec2020'>Rec2020/Rec2100</option>
</select>
<br>Kr: <input id='e_kr'>
<br>Kg: <input id='e_kg'>
<br>Kb: <input id='e_kb'>
<br>Bits: <input id='e_bits'> (use 1 for floats)
<br>Range:
<select id='e_range_type'>
    <option value='narrow' selected>Narrow</option>
    <option value='full'>Full</option>
</select> <span id='e_range_info'></span>
<br>Array order:
<select id='e_array_major'>
    <option value='row' selected>Row-major (common)</option>
    <option value='column'>Column-major (for OpenGL)</option>
</select>
<br>Precision: <input id='e_precision' value='5'>
<br><input type='button' value='recalc' onclick='recalc();'>
<pre id='e_rgbToYcbcr'>-</pre>
<pre id='e_ycbcrToRgb'>-</pre>
<hr>

RGB: <input id='e_r'> <input id='e_g'> <input id='e_b'>
<br>
YCbCr: <input id='e_y'> <input id='e_cb'> <input id='e_cr'>

<script>
'use strict';

function refreshColorSpace() {
    const colorSpace = e_color_space.value;
    if (colorSpace === 'rec601') {
        e_kr.value = 0.299;
        e_kg.value = 0.587;
        e_kb.value = 0.114;
        e_bits.value = 8;
    } else if (colorSpace === 'rec709') {
        e_kr.value = 0.2126;
        e_kg.value = 0.7152;
        e_kb.value = 0.0722;
        e_bits.value = 8;
    } else if (colorSpace === 'rec2020') {
        e_kr.value = 0.2627;
        e_kg.value = '0.6780'; // String to preserve the trailing zero.
        e_kb.value = 0.0593;
        e_bits.value = 10;
    }
    recalc();
}
e_color_space.addEventListener('change', refreshColorSpace);

// -

const FULL_RANGE = {
    y0: 0.0,
    y1: 1.0,
    cbcr0: 0.5,
    cbcr1: 1.0,
};

function getRangeInfo() {
    if (e_range_type.value == 'full') {
        return FULL_RANGE;
    }

    const range = {
        y0: 16,
        y1: 235, // 16+219
        cbcr0: 128,
        cbcr1: 240, // 128+224/2
    };
    const bits = parseInt(e_bits.value);
    if (bits === 1) {
        range.y0 /= 255;
        range.y1 /= 255;
        range.cbcr0 /= 255;
        range.cbcr1 /= 255;
        return range;
    }
    // Fortunately, 10- and 12-bit narrow are just scaled 8-bit narrow.
    range.y0 <<= bits - 8;
    range.y1 <<= bits - 8;
    range.cbcr0 <<= bits - 8;
    range.cbcr1 <<= bits - 8;

    const normalizer = (1 << bits) - 1;
    range.y0 /= normalizer;
    range.y1 /= normalizer;
    range.cbcr0 /= normalizer;
    range.cbcr1 /= normalizer;
    return range;
}

// -

// Make these easy to use in console:
let yuvFromRgb, ycbcrFromYuv;
let ycbcrFromRgb, rgbFromYcbcr;

function recalc() {
    refreshRangeInfo();

    const kr = parseFloat(e_kr.value);
    const kg = parseFloat(e_kg.value);
    const kb = parseFloat(e_kb.value);

    const precision = parseInt(e_precision.value);

    const range = getRangeInfo();
    const y0 = range.y0;
    const y1 = range.y1;
    const cbcr0 = range.cbcr0;
    const cbcr1 = range.cbcr1;

    const uRange = 1-kb;
    const vRange = 1-kr;
    yuvFromRgb = [ [kr, kg, kb, 0],
                   [-kr/uRange, -kg/uRange, (1-kb)/uRange, 0],
                   [(1-kr)/vRange, -kg/vRange, -kb/vRange, 0],
                   [0, 0, 0, 1] ];
    ycbcrFromYuv = [ [y1-y0, 0, 0, y0],
                     [0, cbcr1-cbcr0, 0, cbcr0],
                     [0, 0, cbcr1-cbcr0, cbcr0] ];

    let fnMatToString = matString;
    if (e_array_major.value === 'column') {
        fnMatToString = (x,y) => matString(matTrans(x), y);
    }

    ycbcrFromRgb = matMul(ycbcrFromYuv, yuvFromRgb);
    e_rgbToYcbcr.textContent = 'ycbcrFromRgb = \n' + fnMatToString(ycbcrFromRgb, precision);

    rgbFromYcbcr = matInv(ycbcrFromRgb);
    e_ycbcrToRgb.textContent = 'rgbFromYcbcr = \n' + fnMatToString(rgbFromYcbcr, precision);

    //const back = matInv(rgbFromYcbcr);
    //console.log('ycbcrFromRgb-1-1', fnMatToString(back));
}

// -

function refreshRangeInfo() {
    const bits = parseInt(e_bits.value);
    const normalizer = (1 << bits) - 1;
    const points = (normalizer == 1) ? 5 : 0;

    function round(x) {
        const pointsPow = Math.pow(10, points);
        return Math.round(x * pointsPow) / pointsPow;
    }
    function toFixed(x) {
        return x.toFixed(points);
    }

    const range = getRangeInfo();

    const y0 = toFixed(round(range.y0 * normalizer));
    const y1 = toFixed(round(range.y1 * normalizer));

    let cbcrMid = round(range.cbcr0 * normalizer);
    let cbcrMax = round(range.cbcr1 * normalizer);
    const cbcrMin = toFixed(2*cbcrMid - cbcrMax); // min = mid - (max - mid)
    cbcrMid = toFixed(cbcrMid);
    cbcrMax = toFixed(cbcrMax);

    e_range_info.textContent = `(Y: ${y0}-${y1} CbCr: ${cbcrMin}-${cbcrMid}-${cbcrMax})`;
}

[
    e_kr, e_kg, e_kb,
    e_bits, e_range_type,
    e_array_major, e_precision
].forEach(e => {
    e.addEventListener('change', recalc);
});

// -

function convert(srcElems, destFromSrc, destElems) {
    const bits = parseInt(e_bits.value);
    const normalizer = (1 << bits) - 1;
    const points = parseInt(e_precision.value);

    function round(x) {
        const pointsPow = Math.pow(10, points);
        return Math.round(x * pointsPow) / pointsPow;
    }

    const src = srcElems.map(e => parseFloat(e.value) / normalizer);
    src.push(1);
    const dest = matMulVec(destFromSrc, src);

    for (let i = 0; i < 3; i++) {
        let val = dest[i];
        val = Math.max(0, Math.min(val, 1)); // clamp to [0,1]
        destElems[i].value = round(val*normalizer);
    }
}

// -

const RGB_ELEMS = [e_r, e_g, e_b];
const YCBCR_ELEMS = [e_y, e_cb, e_cr];

function fromRgb() {
    convert(RGB_ELEMS, ycbcrFromRgb, YCBCR_ELEMS);
}

function fromYcbcr() {
    convert(YCBCR_ELEMS, rgbFromYcbcr, RGB_ELEMS);
}

RGB_ELEMS.forEach(e => e.addEventListener('change', fromRgb));
YCBCR_ELEMS.forEach(e => e.addEventListener('change', fromYcbcr));

// -

refreshColorSpace();

e_r.value = 0;
e_g.value = 255;
e_b.value = 0;
fromRgb();
fromYcbcr();

</script>

  </body>
</html>
