<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
  </head>
  <body>
    <pre id='e_info'></pre>
    <div id='e_parent'>
      <canvas id='e_canvas'></canvas>
    </div>
    <script>

document.body.style.height = '200vh';

function ASSERT(cond, text) {
  if (!cond) {
    text = 'Assertion hit: ' + text;
    throw new Error(text);
  }
}

// -

function snap_to_parent_pixels(e) {
  const p = e.parentNode;
  const p_rect = p.getBoundingClientRect();
  const DPR = window.devicePixelRatio;

  const device_rect = {};
  for (const k in p_rect) {
    if (k == 'toJSON') continue;
    device_rect[k] = Math.round(p_rect[k] * DPR);
  };

  e.style.position = 'fixed';
  e.style.top = device_rect.top / DPR + 'px';
  e.style.left = device_rect.left / DPR + 'px';
  e.style.width = device_rect.width / DPR + 'px';
  e.style.height = device_rect.height / DPR + 'px';

  e_info.textContent = [
    'window.devicePixelRatio: ' + DPR,
    'screen.width: ' + screen.width,
    'screen.height: ' + screen.height,
    'window.pageXOffset: ' + window.pageXOffset,
    'screen.pageYOffset: ' + window.pageYOffset,
    'parent_rect: ' + JSON.stringify(p_rect).replace(/,/g, '\n   '),
    'device_rect: ' + JSON.stringify(device_rect).replace(/,/g, '\n   '),
    'e.style.top: ' + e.style.top,
    'e.style.left: ' + e.style.left,
    'e.style.width: ' + e.style.width,
    'e.style.height: ' + e.style.height,
  ].join('\n');

  return device_rect;
}

const attribs = {
  alpha: false,
  premultipliedAlpha: true,
  antialias: false,
  depth: false,
  stencil: false,
  preserveDrawingBuffer: false,
};
const gl = e_canvas.getContext('webgl', attribs);
ASSERT(gl);
ASSERT(gl.drawingBufferWidth == gl.canvas.width);
ASSERT(gl.drawingBufferHeight == gl.canvas.height);

let frame_id = 0;
function frame() {
  requestAnimationFrame(frame);
  frame_id += 1;

  const t = performance.now() / 1000;
  const k = (2.0 + Math.cos(t/2)) / 3.0;


  if (frame_id % 1 == 0) {
    e_parent.style.marginTop = 60 + 30 * Math.sin(t/1) + 'px';
    e_parent.style.marginLeft = 40 + 30 * Math.cos(t/1) + 'px';
  }
  e_parent.style.width = 400 * k + 'px';
  e_parent.style.height = 300 * k + 'px';

  const dev_rect = snap_to_parent_pixels(e_canvas);
  e_canvas.width = dev_rect.width;
  e_canvas.height = dev_rect.height;

  gl.clearColor(1, 1, 1, 1);
  gl.clear(gl.COLOR_BUFFER_BIT);

  gl.enable(gl.SCISSOR_TEST);

  gl.clearColor(1, 0, 0, 1);
  for (let x = 0; x < e_canvas.width; x++) {
    const dev_x = dev_rect.x + x;
    if (dev_x % 2 == 0) continue;
    gl.scissor(x, 0, 1, e_canvas.height);
    gl.clear(gl.COLOR_BUFFER_BIT);
  }

  gl.clearColor(0, 0, 1, 1);
  for (let y = 0; y < e_canvas.height; y++) {
    const dev_y = dev_rect.y + y;
    if (dev_y % 2 == 0) continue;
    gl.scissor(0, e_canvas.height - y - 1, e_canvas.width, 1);
    gl.clear(gl.COLOR_BUFFER_BIT);
  }
}
frame();
    </script>
  </body>
</html>
